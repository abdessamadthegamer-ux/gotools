<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong Merge Master - 麻将消除大师</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #4a90e2 100%);
            overflow: hidden;
            touch-action: manipulation;
            color: white;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: rgba(0,0,0,0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #ffd700;
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
        }

        .score-panel {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
            font-size: 14px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .timer-display {
            color: #ff4757;
            font-size: 18px;
            font-weight: bold;
            background: rgba(255, 71, 87, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #ff4757;
        }

        .board-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 6px;
            width: 360px;
            height: 480px;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 20px;
            border: 3px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .tile {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 2px solid #ddd;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .tile:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .tile.selected {
            border-color: #ffd700;
            background: linear-gradient(145deg, #fff9c4, #ffeb3b);
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            z-index: 10;
        }

        .tile.empty {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.3);
            cursor: default;
        }

        .tile.empty:hover {
            transform: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .tile.falling {
            animation: fallDown 0.6s ease-in-out;
        }

        @keyframes fallDown {
            0% { transform: translateY(-100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Enhanced Mahjong tile styles */
        .tile.bamboo { 
            background: linear-gradient(145deg, #a8e6cf, #7fcdcd); 
            color: #2d5016; 
            border-color: #5cb85c;
        }
        .tile.circle { 
            background: linear-gradient(145deg, #ffd93d, #ffb347); 
            color: #8b4513; 
            border-color: #ff8c00;
        }
        .tile.character { 
            background: linear-gradient(145deg, #ff6b6b, #ff4757); 
            color: white; 
            border-color: #d63031;
        }
        .tile.wind { 
            background: linear-gradient(145deg, #74b9ff, #0984e3); 
            color: white; 
            border-color: #0056b3;
        }
        .tile.dragon { 
            background: linear-gradient(145deg, #fd79a8, #e84393); 
            color: white; 
            border-color: #b83280;
        }
        .tile.flower { 
            background: linear-gradient(145deg, #fdcb6e, #e17055); 
            color: white; 
            border-color: #d63031;
        }
        .tile.season { 
            background: linear-gradient(145deg, #a29bfe, #6c5ce7); 
            color: white; 
            border-color: #5f3dc4;
        }

        .match-effect {
            animation: matchPulse 0.8s ease-out;
        }

        @keyframes matchPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.4); background-color: #ffd700; }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
            animation: comboAnimation 2s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border: 3px solid white;
        }

        @keyframes comboAnimation {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(1.1); }
        }

        .score-popup {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            pointer-events: none;
            z-index: 200;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: scoreFloat 2.5s ease-out forwards;
        }

        @keyframes scoreFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-40px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-100px) scale(0.8); }
        }

        /* Game Over Modal */
        .game-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .modal-content {
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            color: white;
            border: 4px solid #ffd700;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }

        .modal-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .btn {
            background: linear-gradient(45deg, #ffd700, #ffeb3b);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            color: #333;
            text-transform: uppercase;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }

        .btn-special {
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
            border: 2px solid #ffd700;
            animation: specialPulse 2s infinite;
        }

        @keyframes specialPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .power-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 2px solid rgba(255, 215, 0, 0.5);
        }

        .power-button {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            border: none;
            border-radius: 20px;
            padding: 12px 18px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }

        .power-button:hover {
            transform: scale(1.08) translateY(-1px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.5);
        }

        .power-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .special-effects {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            animation: particleFloat 2s ease-out forwards;
        }

        @keyframes particleFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-150px) scale(0.5); }
        }

        .multiplier-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid #ffd700;
            animation: multiplierGlow 1.5s ease-in-out infinite;
        }

        @keyframes multiplierGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-grid {
                width: 300px;
                height: 400px;
            }
            
            .score-panel {
                gap: 15px;
            }
            
            .stat-value {
                font-size: 16px;
            }
            
            .timer-display {
                font-size: 14px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Game Header -->
        <div class="game-header">
            <div class="score-panel">
                <div class="stat-item">
                    <div>Score</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-item">
                    <div>Level</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat-item">
                    <div>Matches</div>
                    <div class="stat-value" id="matches">0</div>
                </div>
                <div class="stat-item">
                    <div>Chain</div>
                    <div class="stat-value" id="chain">0</div>
                </div>
            </div>
            <div class="timer-display">
                ⏱️ <span id="timeLeft">120</span>s
            </div>
        </div>

        <!-- Multiplier Indicator -->
        <div class="multiplier-indicator" id="multiplierDisplay" style="display: none;">
            🔥 x<span id="multiplierValue">2</span> COMBO!
        </div>

        <!-- Game Board -->
        <div class="board-area">
            <div class="special-effects" id="effectsLayer"></div>
            <div class="game-grid" id="gameGrid"></div>
        </div>

        <!-- Power-ups Bar -->
        <div class="power-bar">
            <button class="power-button" id="bombBtn" onclick="useBomb()">
                💣 Bomb (3)
            </button>
            <button class="power-button" id="shuffleBtn" onclick="useShuffle()">
                🌀 Shuffle (2)
            </button>
            <button class="power-button" id="hintBtn" onclick="useHint()">
                💡 Hint (5)
            </button>
            <button class="power-button" id="freezeBtn" onclick="useFreeze()">
                ❄️ Freeze (2)
            </button>
        </div>

        <!-- Game Over Modal -->
        <div class="game-modal" id="gameModal">
            <div class="modal-content">
                <div class="modal-title" id="modalTitle">🎉 Level Complete! 🎉</div>
                <div style="font-size: 18px; margin: 20px 0;">
                    <p>Final Score: <span id="finalScore" style="color: #ffd700; font-weight: bold;">0</span></p>
                    <p>Level Reached: <span id="finalLevel" style="color: #ffd700; font-weight: bold;">0</span></p>
                    <p>Total Matches: <span id="finalMatches" style="color: #ffd700; font-weight: bold;">0</span></p>
                    <p>Best Chain: <span id="bestChain" style="color: #ffd700; font-weight: bold;">0</span></p>
                </div>
                
                <div style="margin: 25px 0;">
                    <button class="btn btn-special" onclick="watchAdForContinue()">
                        📺 Watch Ad - Continue Playing! ⏰
                    </button>
                    <button class="btn btn-special" onclick="watchAdForPowerUps()">
                        🎁 Watch Ad - Power-up Pack! ⚡
                    </button>
                </div>
                
                <div>
                    <button class="btn" onclick="nextLevel()">Next Level 🚀</button>
                    <button class="btn" onclick="restartGame()">New Game 🎮</button>
                    <button class="btn" onclick="shareScore()">Share Score 📱</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== ENHANCED AD MANAGER =====
        class AdvancedAdManager {
            constructor() {
                this.adStats = {
                    totalViews: 0,
                    rewardedViews: 0,
                    revenue: 0
                };
                this.adCooldown = 0;
            }

            showRewardedVideo(callback) {
                if (this.adCooldown > 0) {
                    callback(false);
                    return;
                }
                
                this.adStats.totalViews++;
                this.adCooldown = 30; // 30 second cooldown
                
                // Simulate ad experience
                const loadingTime = Math.random() * 2000 + 1000; // 1-3 seconds
                setTimeout(() => {
                    const success = Math.random() > 0.15; // 85% success rate
                    if (success) {
                        this.adStats.rewardedViews++;
                        this.adStats.revenue += 0.08; // Higher revenue for advanced game
                    }
                    callback(success);
                }, loadingTime);
            }

            updateCooldown() {
                if (this.adCooldown > 0) this.adCooldown--;
            }
        }

        class MahjongMergeMaster {
            constructor() {
                this.board = [];
                this.score = 0;
                this.level = 1;
                this.matches = 0;
                this.chain = 0;
                this.bestChain = 0;
                this.timeLeft = 120;
                this.selectedTiles = [];
                this.gameActive = true;
                this.multiplier = 1;
                this.multiplierTimer = 0;
                this.adManager = new AdvancedAdManager();
                
                // Enhanced power-ups
                this.powerUps = {
                    bomb: 3,
                    shuffle: 2,
                    hint: 5,
                    freeze: 2
                };

                // Expanded tile types with more variety
                this.tileTypes = [
                    { type: 'bamboo', symbol: '🎋', value: 1, rarity: 'common' },
                    { type: 'bamboo', symbol: '🎋', value: 2, rarity: 'common' },
                    { type: 'bamboo', symbol: '🎋', value: 3, rarity: 'common' },
                    { type: 'circle', symbol: '⭕', value: 1, rarity: 'common' },
                    { type: 'circle', symbol: '⭕', value: 2, rarity: 'common' },
                    { type: 'circle', symbol: '⭕', value: 3, rarity: 'common' },
                    { type: 'character', symbol: '漢', value: 1, rarity: 'common' },
                    { type: 'character', symbol: '字', value: 2, rarity: 'common' },
                    { type: 'character', symbol: '中', value: 3, rarity: 'common' },
                    { type: 'wind', symbol: '風', value: 1, rarity: 'uncommon' },
                    { type: 'wind', symbol: '東', value: 2, rarity: 'uncommon' },
                    { type: 'wind', symbol: '南', value: 3, rarity: 'uncommon' },
                    { type: 'dragon', symbol: '龍', value: 1, rarity: 'rare' },
                    { type: 'dragon', symbol: '白', value: 2, rarity: 'rare' },
                    { type: 'flower', symbol: '花', value: 1, rarity: 'epic' },
                    { type: 'season', symbol: '春', value: 1, rarity: 'legendary' }
                ];

                this.init();
            }

            init() {
                this.generateBoard();
                this.renderBoard();
                this.updateUI();
                this.startTimer();
            }

            generateBoard() {
                this.board = Array(8).fill().map(() => Array(6).fill(null));
                
                // Fill board with weighted random tiles
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 6; col++) {
                        if (Math.random() > 0.15) { // 85% chance to have a tile
                            const tileType = this.getWeightedRandomTile();
                            this.board[row][col] = {
                                ...tileType,
                                id: `${row}-${col}`,
                                row,
                                col
                            };
                        }
                    }
                }

                // Ensure some guaranteed matches
                this.addStrategicMatches();
            }

            getWeightedRandomTile() {
                const weights = {
                    'common': 70,
                    'uncommon': 20,
                    'rare': 8,
                    'epic': 1.5,
                    'legendary': 0.5
                };
                
                const rand = Math.random() * 100;
                let cumulative = 0;
                
                for (const [rarity, weight] of Object.entries(weights)) {
                    cumulative += weight;
                    if (rand <= cumulative) {
                        const tilesOfRarity = this.tileTypes.filter(t => t.rarity === rarity);
                        return tilesOfRarity[Math.floor(Math.random() * tilesOfRarity.length)];
                    }
                }
                
                return this.tileTypes[0]; // fallback
            }

            addStrategicMatches() {
                // Add guaranteed matches based on level
                const guaranteedMatches = Math.min(2 + Math.floor(this.level / 3), 5);
                
                for (let i = 0; i < guaranteedMatches; i++) {
                    const row = Math.floor(Math.random() * 6) + 1;
                    const col = Math.floor(Math.random() * 4);
                    const tileType = this.tileTypes[Math.floor(Math.random() * 9)]; // Use common tiles
                    
                    // Create horizontal match
                    for (let j = 0; j < 3; j++) {
                        if (col + j < 6) {
                            this.board[row][col + j] = {
                                ...tileType,
                                id: `${row}-${col + j}`,
                                row: row,
                                col: col + j
                            };
                        }
                    }
                }
            }

            refillBoard() {
                for (let col = 0; col < 6; col++) {
                    for (let row = 0; row < 8; row++) {
                        if (!this.board[row][col]) {
                            // Higher chance of tiles in higher levels
                            const fillChance = 0.6 + (this.level * 0.05);
                            if (Math.random() < fillChance) {
                                const tileType = this.getWeightedRandomTile();
                                this.board[row][col] = {
                                    ...tileType,
                                    id: `${row}-${col}`,
                                    row,
                                    col
                                };
                            }
                        }
                    }
                }
            }

            checkAutoMatches() {
                // Check for automatic matches after refill
                let foundAutoMatch = false;
                const allTiles = [];
                
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 6; col++) {
                        if (this.board[row][col]) {
                            allTiles.push(this.board[row][col]);
                        }
                    }
                }

                // Look for auto-matches
                for (let i = 0; i < allTiles.length - 2; i++) {
                    for (let j = i + 1; j < allTiles.length - 1; j++) {
                        for (let k = j + 1; k < allTiles.length; k++) {
                            if (this.canMatch([allTiles[i], allTiles[j], allTiles[k]])) {
                                // Auto-process this match
                                this.selectedTiles = [allTiles[i], allTiles[j], allTiles[k]];
                                setTimeout(() => this.processMatch(), 1000);
                                foundAutoMatch = true;
                                break;
                            }
                        }
                        if (foundAutoMatch) break;
                    }
                    if (foundAutoMatch) break;
                }
            }

            deselectAll() {
                this.selectedTiles = [];
                document.querySelectorAll('.tile.selected').forEach(tile => {
                    tile.classList.remove('selected');
                });
            }

            showScorePopup(score) {
                const popup = document.createElement('div');
                popup.className = 'score-popup';
                popup.textContent = `+${score}`;
                popup.style.left = '50%';
                popup.style.top = '40%';
                
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 2500);
            }

            showComboDisplay() {
                const display = document.createElement('div');
                display.className = 'combo-display';
                display.textContent = `🔥 ${this.chain}x CHAIN! 🔥`;
                
                document.getElementById('gameGrid').appendChild(display);
                setTimeout(() => display.remove(), 2000);
            }

            showMultiplier() {
                const indicator = document.getElementById('multiplierDisplay');
                document.getElementById('multiplierValue').textContent = this.multiplier;
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }

            createParticles() {
                const effectsLayer = document.getElementById('effectsLayer');
                for (let i = 0; i < 8; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    effectsLayer.appendChild(particle);
                    setTimeout(() => particle.remove(), 2000);
                }
            }

            updateUI() {
                document.getElementById('score').textContent = this.score.toLocaleString();
                document.getElementById('level').textContent = this.level;
                document.getElementById('matches').textContent = this.matches;
                document.getElementById('chain').textContent = this.chain;
                
                // Update power-up buttons
                document.getElementById('bombBtn').innerHTML = `💣 Bomb (${this.powerUps.bomb})`;
                document.getElementById('shuffleBtn').innerHTML = `🌀 Shuffle (${this.powerUps.shuffle})`;
                document.getElementById('hintBtn').innerHTML = `💡 Hint (${this.powerUps.hint})`;
                document.getElementById('freezeBtn').innerHTML = `❄️ Freeze (${this.powerUps.freeze})`;
                
                document.getElementById('bombBtn').disabled = this.powerUps.bomb <= 0;
                document.getElementById('shuffleBtn').disabled = this.powerUps.shuffle <= 0;
                document.getElementById('hintBtn').disabled = this.powerUps.hint <= 0;
                document.getElementById('freezeBtn').disabled = this.powerUps.freeze <= 0;

                // Level progression
                if (this.matches >= this.level * 15) {
                    this.levelUp();
                }
            }

            levelUp() {
                this.level++;
                this.timeLeft += 30; // Bonus time
                this.showComboDisplay();
                
                // Add bonus power-ups
                this.powerUps.bomb += 1;
                this.powerUps.hint += 2;
                
                if (this.level % 3 === 0) {
                    this.powerUps.shuffle += 1;
                    this.powerUps.freeze += 1;
                }
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    document.getElementById('timeLeft').textContent = this.timeLeft;
                    
                    // Update multiplier timer
                    if (this.multiplierTimer > 0) {
                        this.multiplierTimer--;
                        if (this.multiplierTimer <= 0) {
                            this.multiplier = 1;
                        }
                    }
                    
                    // Update ad cooldown
                    this.adManager.updateCooldown();
                    
                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                }, 1000);
            }

            endGame() {
                clearInterval(this.timerInterval);
                this.gameActive = false;
                
                document.getElementById('finalScore').textContent = this.score.toLocaleString();
                document.getElementById('finalLevel').textContent = this.level;
                document.getElementById('finalMatches').textContent = this.matches;
                document.getElementById('bestChain').textContent = this.bestChain;
                
                if (this.timeLeft <= 0) {
                    document.getElementById('modalTitle').textContent = '⏰ Time\'s Up!';
                } else {
                    document.getElementById('modalTitle').textContent = '🎉 Amazing Score!';
                }
                
                document.getElementById('gameModal').style.display = 'flex';
            }

            // Enhanced Power-ups
            useBomb() {
                if (this.powerUps.bomb <= 0 || !this.gameActive) return;
                this.powerUps.bomb--;
                
                // Clear a 3x3 area around a random high-value tile
                let bestTile = null;
                let bestValue = 0;
                
                for (let row = 1; row < 7; row++) {
                    for (let col = 1; col < 5; col++) {
                        if (this.board[row][col]) {
                            const rarity = this.board[row][col].rarity;
                            const value = {'common': 1, 'uncommon': 2, 'rare': 3, 'epic': 4, 'legendary': 5}[rarity];
                            if (value > bestValue) {
                                bestValue = value;
                                bestTile = {row, col};
                            }
                        }
                    }
                }
                
                if (bestTile) {
                    const {row, col} = bestTile;
                    for (let r = row - 1; r <= row + 1; r++) {
                        for (let c = col - 1; c <= col + 1; c++) {
                            if (this.board[r] && this.board[r][c]) {
                                this.board[r][c] = null;
                            }
                        }
                    }
                    
                    this.score += 500;
                    this.createParticles();
                    
                    setTimeout(() => {
                        this.applyGravity();
                        this.refillBoard();
                        this.renderBoard();
                    }, 500);
                }
                
                this.updateUI();
            }

            useShuffle() {
                if (this.powerUps.shuffle <= 0 || !this.gameActive) return;
                this.powerUps.shuffle--;
                
                const tiles = [];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 6; col++) {
                        if (this.board[row][col]) {
                            tiles.push(this.board[row][col]);
                            this.board[row][col] = null;
                        }
                    }
                }
                
                // Advanced shuffle with guaranteed matches
                for (let i = tiles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
                }
                
                let tileIndex = 0;
                for (let row = 0; row < 8 && tileIndex < tiles.length; row++) {
                    for (let col = 0; col < 6 && tileIndex < tiles.length; col++) {
                        if (Math.random() > 0.1) {
                            this.board[row][col] = {
                                ...tiles[tileIndex],
                                row, col,
                                id: `${row}-${col}`
                            };
                            tileIndex++;
                        }
                    }
                }
                
                this.renderBoard();
                this.updateUI();
            }

            useHint() {
                if (this.powerUps.hint <= 0 || !this.gameActive) return;
                this.powerUps.hint--;
                
                // Find best possible match
                const allTiles = [];
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 6; col++) {
                        if (this.board[row][col]) {
                            allTiles.push(this.board[row][col]);
                        }
                    }
                }

                for (let i = 0; i < allTiles.length - 2; i++) {
                    for (let j = i + 1; j < allTiles.length - 1; j++) {
                        for (let k = j + 1; k < allTiles.length; k++) {
                            if (this.canMatch([allTiles[i], allTiles[j], allTiles[k]])) {
                                [allTiles[i], allTiles[j], allTiles[k]].forEach(tile => {
                                    const element = document.querySelector(`[data-row="${tile.row}"][data-col="${tile.col}"]`);
                                    element.style.border = '4px solid #00ff00';
                                    element.style.animation = 'specialPulse 1s infinite';
                                    setTimeout(() => {
                                        element.style.border = '';
                                        element.style.animation = '';
                                    }, 3000);
                                });
                                this.updateUI();
                                return;
                            }
                        }
                    }
                }
                
                this.updateUI();
            }

            useFreeze() {
                if (this.powerUps.freeze <= 0 || !this.gameActive) return;
                this.powerUps.freeze--;
                
                this.timeLeft += 30;
                document.getElementById('timeLeft').style.color = '#00ff00';
                setTimeout(() => {
                    document.getElementById('timeLeft').style.color = '#ff4757';
                }, 2000);
                
                this.updateUI();
            }

            nextLevel() {
                this.levelUp();
                document.getElementById('gameModal').style.display = 'none';
                this.gameActive = true;
                this.generateBoard();
                this.renderBoard();
            }

            restart() {
                clearInterval(this.timerInterval);
                this.score = 0;
                this.level = 1;
                this.matches = 0;
                this.chain = 0;
                this.bestChain = 0;
                this.timeLeft = 120;
                this.multiplier = 1;
                this.multiplierTimer = 0;
                this.gameActive = true;
                this.powerUps = { bomb: 3, shuffle: 2, hint: 5, freeze: 2 };
                
                document.getElementById('gameModal').style.display = 'none';
                this.generateBoard();
                this.renderBoard();
                this.updateUI();
                this.startTimer();
            }
        }

        // Global game instance
        let game;

        // Initialize game
        window.addEventListener('load', () => {
            game = new MahjongMergeMaster();
        });

        // ===== AD INTEGRATION FUNCTIONS =====
        function watchAdForContinue() {
            game.adManager.showRewardedVideo((success) => {
                if (success) {
                    game.timeLeft += 60;
                    game.gameActive = true;
                    document.getElementById('gameModal').style.display = 'none';
                    alert('🎉 +60 Seconds Added! Keep playing!');
                } else {
                    alert('Ad was skipped - no bonus time given');
                }
            });
        }

        function watchAdForPowerUps() {
            game.adManager.showRewardedVideo((success) => {
                if (success) {
                    game.powerUps.bomb += 2;
                    game.powerUps.shuffle += 1;
                    game.powerUps.hint += 3;
                    game.powerUps.freeze += 1;
                    game.updateUI();
                    alert('🎁 Power-up Pack Added!\n+2 Bombs, +1 Shuffle, +3 Hints, +1 Freeze!');
                } else {
                    alert('Ad was skipped - no power-ups given');
                }
            });
        }

        function useBomb() {
            game.useBomb();
        }

        function useShuffle() {
            game.useShuffle();
        }

        function useHint() {
            game.useHint();
        }

        function useFreeze() {
            game.useFreeze();
        }

        function nextLevel() {
            game.nextLevel();
        }

        function restartGame() {
            game.restart();
        }

        function shareScore() {
            const shareText = `🎉 Just scored ${game.score.toLocaleString()} points in Mahjong Merge Master! 🀄

🏆 Level: ${game.level}
🎯 Matches: ${game.matches}  
🔥 Best Chain: ${game.bestChain}x

Think you can beat my score? 😏
#MahjongMaster #PuzzleChallenge #BrainGames #ChainMaster`;

            if (navigator.share) {
                navigator.share({
                    title: 'Mahjong Merge Master - High Score!',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText + '\n' + window.location.href);
                alert('Score copied to clipboard! Share it with friends! 📱');
            }
        }

        // Prevent context menu and zoom
        document.addEventListener('contextmenu', e => e.preventDefault());
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Performance optimization
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && game) {
                // Pause game when tab is hidden
                game.gameActive = false;
            } else if (game) {
                // Resume game when tab is visible
                game.gameActive = true;
            }
        });
    </script>
</body>
</html>

            renderBoard() {
                const gridElement = document.getElementById('gameGrid');
                gridElement.innerHTML = '';

                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 6; col++) {
                        const tileDiv = document.createElement('div');
                        tileDiv.className = 'tile';
                        tileDiv.dataset.row = row;
                        tileDiv.dataset.col = col;

                        if (this.board[row][col]) {
                            const tile = this.board[row][col];
                            tileDiv.classList.add(tile.type);
                            
                            // Add rarity indicator
                            let rarityIndicator = '';
                            if (tile.rarity === 'epic') rarityIndicator = '✨';
                            if (tile.rarity === 'legendary') rarityIndicator = '🌟';
                            
                            tileDiv.innerHTML = `
                                <div style="font-size: 20px;">${tile.symbol}${rarityIndicator}</div>
                                <div style="font-size: 10px; opacity: 0.8;">${tile.value}</div>
                            `;
                            tileDiv.addEventListener('click', () => this.selectTile(row, col));
                        } else {
                            tileDiv.classList.add('empty');
                        }

                        gridElement.appendChild(tileDiv);
                    }
                }
            }

            selectTile(row, col) {
                if (!this.gameActive || !this.board[row][col]) return;

                const tileElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                const tile = this.board[row][col];

                if (this.selectedTiles.some(t => t.row === row && t.col === col)) {
                    // Deselect tile
                    this.selectedTiles = this.selectedTiles.filter(t => !(t.row === row && t.col === col));
                    tileElement.classList.remove('selected');
                    return;
                }

                if (this.selectedTiles.length < 3) {
                    this.selectedTiles.push(tile);
                    tileElement.classList.add('selected');

                    if (this.selectedTiles.length === 3) {
                        setTimeout(() => this.checkMatch(), 300);
                    }
                }
            }

            checkMatch() {
                if (!this.canMatch(this.selectedTiles)) {
                    this.deselectAll();
                    this.chain = 0; // Break chain on invalid match
                    return;
                }

                this.processMatch();
                
                if (this.timeLeft <= 0) {
                    this.endGame();
                }
            }

            canMatch(tiles) {
                if (tiles.length !== 3) return false;

                // Same type and value
                const sameType = tiles.every(t => t.type === tiles[0].type && t.value === tiles[0].value);
                if (sameType) return true;

                // Sequence of same type
                const sameTypeSequence = tiles.every(t => t.type === tiles[0].type);
                if (sameTypeSequence) {
                    const values = tiles.map(t => t.value).sort((a, b) => a - b);
                    return values[0] === 1 && values[1] === 2 && values[2] === 3;
                }

                // Same value, different types
                const sameValue = tiles.every(t => t.value === tiles[0].value);
                const differentTypes = new Set(tiles.map(t => t.type)).size === 3;
                
                // Bonus for rare tile combinations
                const hasRare = tiles.some(t => ['epic', 'legendary'].includes(t.rarity));
                
                return (sameValue && differentTypes) || hasRare;
            }

            processMatch() {
                // Remove matched tiles with animation
                this.selectedTiles.forEach(tile => {
                    const element = document.querySelector(`[data-row="${tile.row}"][data-col="${tile.col}"]`);
                    element.classList.add('match-effect');
                    this.board[tile.row][tile.col] = null;
                });

                // Calculate enhanced score
                this.chain++;
                this.matches++;
                
                if (this.chain > this.bestChain) {
                    this.bestChain = this.chain;
                }

                // Rarity bonus
                const rarityBonus = this.selectedTiles.reduce((bonus, tile) => {
                    const multipliers = { 'common': 1, 'uncommon': 1.5, 'rare': 2, 'epic': 3, 'legendary': 5 };
                    return bonus * multipliers[tile.rarity];
                }, 1);

                const baseScore = 150;
                const chainBonus = this.chain * 75;
                const levelBonus = this.level * 30;
                const multiplierBonus = this.multiplier;
                
                const totalScore = Math.floor((baseScore + chainBonus + levelBonus) * rarityBonus * multiplierBonus);
                this.score += totalScore;

                // Update multiplier
                if (this.chain >= 3) {
                    this.multiplier = Math.min(this.chain, 5);
                    this.multiplierTimer = 10;
                    this.showMultiplier();
                }

                // Show effects
                this.showScorePopup(totalScore);
                if (this.chain > 1) {
                    this.showComboDisplay();
                }
                
                this.createParticles();

                // Apply physics and refill
                setTimeout(() => {
                    this.applyGravity();
                    this.refillBoard();
                    this.renderBoard();
                    this.checkAutoMatches();
                }, 800);

                this.deselectAll();
                this.updateUI();
            }

            applyGravity() {
                for (let col = 0; col < 6; col++) {
                    const columnTiles = [];
                    for (let row = 7; row >= 0; row--) {
                        if (this.board[row][col]) {
                            columnTiles.push(this.board[row][col]);
                            this.board[row][col] = null;
                        }
                    }
                    
                    for (let i = 0; i < columnTiles.length; i++) {
                        const newRow = 7 - i;
                        this.board[newRow][col] = {
                            ...columnTiles[i],
                            row: newRow,
                            col: col,
                            id: `${newRow}-${col}`
                        };
                    }
